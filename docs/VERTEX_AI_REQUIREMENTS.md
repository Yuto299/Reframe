# Vertex AI統合機能 要件定義書

## 1. 概要

テキストボックスに入力された複数の話題を自動的に分割し、Vertex AIを使用して過去のナレッジとの関連性を分析し、適切に接続または新規作成する機能。

### 1.1 ユースケース例

ユーザーがテキストボックスに以下のように複数の話題を同時に入力した場合：

```
オレンジジュースの作り方
材料：オレンジ3個、砂糖大さじ2
手順：1. オレンジを絞る 2. 砂糖を加える 3. 混ぜる

リンゴジュースの作り方
材料：リンゴ2個、レモン汁小さじ1
手順：1. リンゴをすりおろす 2. レモン汁を加える 3. 濾す
```

AIが自動的に以下の2つのトピックに分割：
- 「オレンジジュースの作り方」
- 「リンゴジュースの作り方」

それぞれを個別のナレッジとして扱い、既存のナレッジとの関連性を検索・表示する。

## 2. 機能要件

### 2.1 トピック分割機能（Analyze Topics）

#### 2.1.1 機能説明
- テキストボックスに入力されたテキストを、Vertex AIのGenerative AI APIを使用して複数のトピックに自動分割
- 分割された各トピックは、独立したナレッジ候補として扱う

#### 2.1.2 Vertex AI使用箇所
- **API**: Generative AI API
- **モデル**: `gemini-pro` または `text-bison`
- **用途**: 入力テキストから複数のトピックを抽出・分割

#### 2.1.3 入力
- テキストボックスに入力されたテキスト（複数の話題が含まれる可能性がある）

#### 2.1.4 出力
- 分割された各トピックのリスト
- 各トピックには以下が含まれる：
  - タイトル（自動生成または抽出）
  - 内容（分割されたテキスト）
  - 既存ナレッジとの関連性スコア（後述の関連ナレッジ検索で取得）

#### 2.1.5 表示形式
- 現在の`SearchResults`コンポーネントと同様の形式で表示
- 各トピックをカード形式で表示
- チェックボックスで選択可能
- 関連度スコアが高い場合は「High Match」バッジを表示

### 2.2 関連ナレッジ検索機能

#### 2.2.1 機能説明
- 分割された各トピックについて、Vertex AIのEmbeddings APIを使用して既存のナレッジとの関連性を検索
- セマンティック検索により、意味的に類似したナレッジを発見

#### 2.2.2 Vertex AI使用箇所
- **API**: Embeddings API
- **モデル**: `textembedding-gecko@003`
- **用途**: 各トピックの埋め込みベクトルを生成し、既存ナレッジの埋め込みベクトルと比較して関連度を算出

#### 2.2.3 入力
- 分割された各トピックのテキスト

#### 2.2.4 出力
- 各トピックに対して、関連度スコア付きの既存ナレッジリスト
- 関連度スコアは0-100の整数値
- スコアが80以上の場合は「High Match」として表示

### 2.3 ナレッジ接続・作成機能（Connect Topics）

#### 2.3.1 機能説明
- ユーザーが選択したトピックについて、以下の処理を実行：
  1. 既存の関連ナレッジがある場合：新規ナレッジを作成し、関連ナレッジと接続
  2. 既存の関連ナレッジがない場合：新規ナレッジを単独で作成

#### 2.3.2 処理フロー
1. ユーザーが「Connect Topics」ボタンをクリック
2. 選択された各トピックについて：
   - 新規ナレッジを作成
   - 関連度スコアが閾値（例：70以上）を超える既存ナレッジと接続
3. 処理完了後、自動的に`/graph`ページに遷移して更新されたナレッジネットワークを表示

#### 2.3.3 ナビゲーション
- 処理完了後、必ず`/graph`ページに自動遷移
- グラフ一覧ページを経由して、作成・接続されたナレッジを視覚的に確認できる

## 3. UI/UX要件

### 3.1 ボタン配置

#### 3.1.1 「Analyze Topics」ボタン
- **位置**: テキストボックスの下、既存の「Find Connections」ボタンの近く
- **機能**: 入力テキストをVertex AIで分割し、結果を表示
- **状態**:
  - 通常: 「Analyze Topics」
  - 処理中: 「Analyzing...」（ローディングアイコン付き）
  - 無効化: テキストが空の場合

#### 3.1.2 「Connect Topics」ボタン
- **位置**: 分割結果が表示された後、画面下部に固定表示（既存の「Connect Items」ボタンと同様の位置）
- **機能**: 選択されたトピックをナレッジとして作成・接続
- **状態**:
  - 通常: 「Connect Topics」
  - 処理中: 「Connecting...」（ローディングアイコン付き）
  - 無効化: トピックが1つも選択されていない場合

### 3.2 表示エリア

#### 3.2.1 トピック分割結果の表示
- `SearchResults`コンポーネントと同様の形式
- 各トピックをカード形式で表示
- チェックボックスで選択可能
- 関連度スコアが高い既存ナレッジがある場合は「High Match」バッジを表示
- 各トピックの下に、関連する既存ナレッジを表示（オプション）

#### 3.2.2 エラーハンドリング
- Vertex AI API呼び出しエラー時は、エラーメッセージを表示
- ネットワークエラー時は、リトライ可能なメッセージを表示

## 4. 技術要件

### 4.1 Vertex AI設定

#### 4.1.1 必要な環境変数
- `GOOGLE_CLOUD_PROJECT`: GCPプロジェクトID
- `GOOGLE_APPLICATION_CREDENTIALS`: サービスアカウントキーのパス（ローカル開発時）
- `VERTEX_AI_LOCATION`: リージョン（例：`asia-northeast1`）

#### 4.1.2 使用するVertex AIモデル
- **Generative AI**: `gemini-pro` または `text-bison`
- **Embeddings**: `textembedding-gecko@003`

### 4.2 APIエンドポイント

#### 4.2.1 POST /api/knowledge/analyze-topics
- **機能**: テキストをトピックに分割
- **リクエスト**:
  ```json
  {
    "text": "オレンジジュースの作り方...リンゴジュースの作り方..."
  }
  ```
- **レスポンス**:
  ```json
  {
    "data": [
      {
        "title": "オレンジジュースの作り方",
        "content": "材料：オレンジ3個、砂糖大さじ2...",
        "relatedKnowledge": [
          {
            "knowledge": { ... },
            "relevanceScore": 85
          }
        ]
      },
      {
        "title": "リンゴジュースの作り方",
        "content": "材料：リンゴ2個、レモン汁小さじ1...",
        "relatedKnowledge": []
      }
    ]
  }
  ```

#### 4.2.2 POST /api/knowledge/connect-topics
- **機能**: 選択されたトピックをナレッジとして作成・接続
- **リクエスト**:
  ```json
  {
    "topics": [
      {
        "title": "オレンジジュースの作り方",
        "content": "...",
        "relatedKnowledgeIds": ["knowledge-id-1", "knowledge-id-2"]
      }
    ]
  }
  ```
- **レスポンス**: 204 No Content（成功時）

### 4.3 パフォーマンス要件

- トピック分割: 5秒以内
- 関連ナレッジ検索: トピック1つあたり2秒以内
- 全体の処理時間: トピック数 × 2秒 + 5秒以内

### 4.4 エラーハンドリング

- Vertex AI API呼び出しエラー: 適切なエラーメッセージを返す
- バリデーションエラー: 入力テキストが空、または長すぎる場合
- ネットワークエラー: リトライ可能なエラーとして扱う

## 5. データフロー

### 5.1 Analyze Topics フロー

```
1. ユーザーがテキストを入力
2. 「Analyze Topics」ボタンをクリック
3. フロントエンド → バックエンド: POST /api/knowledge/analyze-topics
4. バックエンド: Vertex AI Generative APIでトピック分割
5. バックエンド: 各トピックについて、Vertex AI Embeddings APIで関連ナレッジ検索
6. バックエンド → フロントエンド: 分割結果と関連ナレッジを返す
7. フロントエンド: SearchResults形式で表示
```

### 5.2 Connect Topics フロー

```
1. ユーザーがトピックを選択
2. 「Connect Topics」ボタンをクリック
3. フロントエンド → バックエンド: POST /api/knowledge/connect-topics
4. バックエンド: 各トピックをナレッジとして作成
5. バックエンド: 関連ナレッジと接続（関連度スコアが閾値以上の場合）
6. バックエンド → フロントエンド: 204 No Content
7. フロントエンド: /graphページに自動遷移
```

## 6. 実装優先順位

### Phase 1: 基本機能
1. Vertex AIサービスの実装（Infrastructure層）
2. トピック分割ユースケースの実装（Application層）
3. Analyze Topics APIエンドポイントの実装（API層）
4. フロントエンドの「Analyze Topics」ボタンと結果表示

### Phase 2: 関連ナレッジ検索
1. Embeddings APIを使用した関連ナレッジ検索の実装
2. 関連度スコアの計算ロジック
3. フロントエンドでの関連ナレッジ表示

### Phase 3: 接続・作成機能
1. Connect Topics APIエンドポイントの実装
2. ナレッジ作成・接続ロジック
3. フロントエンドの「Connect Topics」ボタンとナビゲーション

## 7. 注意事項

### 7.1 Vertex AI APIの制限
- レート制限に注意
- コスト管理（特にEmbeddings APIの呼び出し回数）
- エラーハンドリングとリトライロジックの実装

### 7.2 パフォーマンス最適化
- トピック分割結果のキャッシュ（オプション）
- 関連ナレッジ検索の並列処理
- デバウンス処理（Analyze Topicsボタンの連打防止）

### 7.3 ユーザー体験
- ローディング状態の明確な表示
- エラー時の適切なメッセージ
- 処理完了後の明確なフィードバック（/graphページへの遷移）

## 8. 参考実装

### 8.1 既存コンポーネント
- `SearchResults.tsx`: トピック分割結果の表示形式の参考
- `KnowledgeInput.tsx`: テキストボックスとボタンの配置の参考
- `SearchPage.tsx`: 全体のフロー管理の参考

### 8.2 既存API
- `POST /api/knowledge/search`: 検索APIの実装パターンの参考
- `POST /api/knowledge`: ナレッジ作成APIの実装パターンの参考
