# 機能仕様書

## 1. 機能一覧

### 1.1 知識管理機能

#### 1.1.1 知識の作成
**概要**: 新しい知識をシステムに登録する

**詳細仕様**:
- **エンドポイント**: `POST /api/knowledge`
- **リクエストボディ**:
  ```json
  {
    "title": "知識のタイトル",
    "content": "知識の内容"
  }
  ```
- **バリデーション**:
  - `title`: 1-200文字（必須）
  - `content`: 1-10,000文字（必須）
- **レスポンス**: 
  ```json
  {
    "data": {
      "id": "knowledge-id",
      "title": "知識のタイトル",
      "content": "知識の内容",
      "createdAt": "2024-01-24T00:00:00.000Z",
      "connections": []
    }
  }
  ```
- **ステータスコード**: 201 Created

#### 1.1.2 知識の検索
**概要**: キーワードで知識を検索する

**詳細仕様**:
- **エンドポイント**: `POST /api/knowledge/search`
- **リクエストボディ**:
  ```json
  {
    "query": "検索キーワード"
  }
  ```
- **検索アルゴリズム**:
  1. タイトルに完全一致: +10点
  2. コンテンツに完全一致: +5点
  3. タイトルに単語一致: +3点/単語
  4. コンテンツに単語一致: +1点/単語
- **レスポンス**:
  ```json
  {
    "data": [
      {
        "knowledge": {
          "id": "knowledge-id",
          "title": "知識のタイトル",
          "content": "知識の内容",
          "createdAt": "2024-01-24T00:00:00.000Z",
          "connections": []
        },
        "relevanceScore": 15
      }
    ]
  }
  ```
- **最大件数**: 10件
- **ステータスコード**: 200 OK

#### 1.1.3 知識の取得（ID指定）
**概要**: IDで特定の知識を取得する

**詳細仕様**:
- **エンドポイント**: `GET /api/knowledge/:id`
- **パスパラメータ**: `id` (string)
- **レスポンス**:
  ```json
  {
    "data": {
      "id": "knowledge-id",
      "title": "知識のタイトル",
      "content": "知識の内容",
      "createdAt": "2024-01-24T00:00:00.000Z",
      "connections": ["connected-id-1", "connected-id-2"]
    }
  }
  ```
- **ステータスコード**: 200 OK
- **エラー**: 404 Not Found（知識が見つからない場合）

#### 1.1.4 知識の一覧取得
**概要**: 全ての知識を取得する

**詳細仕様**:
- **エンドポイント**: `GET /api/knowledge`
- **レスポンス**:
  ```json
  {
    "data": [
      {
        "id": "knowledge-id",
        "title": "知識のタイトル",
        "content": "知識の内容",
        "createdAt": "2024-01-24T00:00:00.000Z",
        "connections": []
      }
    ]
  }
  ```
- **ステータスコード**: 200 OK

### 1.2 知識接続機能

#### 1.2.1 知識の接続
**概要**: 複数の知識を選択して、新しい知識と接続する

**詳細仕様**:
- **エンドポイント**: `POST /api/knowledge/:id/connect`
- **パスパラメータ**: `id` (string) - 新規作成する知識のID
- **リクエストボディ**:
  ```json
  {
    "targetIds": ["target-id-1", "target-id-2"]
  }
  ```
- **動作**:
  1. 新規知識を作成（検索クエリをコンテンツとして使用）
  2. 新規知識と各ターゲット知識を双方向で接続
  3. 既存の接続は重複しない
- **レスポンス**: 204 No Content
- **ステータスコード**: 204 No Content
- **エラー**: 
  - 400 Bad Request（targetIdsが配列でない場合）
  - 404 Not Found（知識が見つからない場合）

### 1.3 可視化機能

#### 1.3.1 グラフビュー
**概要**: 知識ネットワークをグラフとして可視化

**詳細仕様**:
- **ノード**:
  - 表示内容: 知識のタイトル
  - クリック: 知識の詳細をシートで表示
  - スタイル: デフォルトのReactFlowノード
- **エッジ**:
  - タイプ: 無向エッジ（双方向）
  - スタイル: デフォルトのReactFlowエッジ
- **レイアウト**:
  - アルゴリズム: ReactFlowのデフォルトレイアウト
  - 初期表示: 自動レイアウト
- **インタラクション**:
  - ズーム: マウスホイール
  - パン: ドラッグ
  - ノード移動: ドラッグ可能

#### 1.3.2 グラフ設定
**概要**: グラフの表示オプションを変更する

**詳細仕様**:
- **日付表示**:
  - トグル: 作成日時の表示/非表示
  - デフォルト: 非表示

#### 1.3.3 統計情報
**概要**: グラフの統計情報を表示

**詳細仕様**:
- **ノード数**: 知識の総数
- **エッジ数**: 接続の総数（双方向なので2で割る）

### 1.4 UI機能

#### 1.4.1 検索ページ
**概要**: 知識の検索と接続を行う

**詳細仕様**:
- **URL**: `/search`
- **コンポーネント**:
  - `KnowledgeInput`: 検索入力欄
    - プレースホルダー: "Search knowledge..."
    - 検索ボタン: 検索実行
    - ローディング状態: 検索中の表示
  - `SearchResults`: 検索結果リスト
    - チェックボックス: 複数選択可能
    - 詳細ボタン: 知識の詳細を表示
    - 関連度スコア: 表示
  - `KnowledgeDetail`: 知識の詳細シート
    - タイトル: 表示
    - コンテンツ: 表示
    - 作成日時: 表示
    - 接続数: 表示
  - 接続ボタン: 選択した知識を接続
    - 無効化: 選択がない場合
    - ローディング状態: 接続中の表示

#### 1.4.2 グラフページ
**概要**: 知識ネットワークをグラフで表示

**詳細仕様**:
- **URL**: `/graph`
- **コンポーネント**:
  - `KnowledgeGraph`: グラフキャンバス
    - ReactFlowを使用
    - ノードとエッジを表示
  - `GraphSettings`: 設定パネル
    - 日付表示のトグル
  - 統計情報カード:
    - ノード数
    - エッジ数
    - リフレッシュボタン
  - `KnowledgeDetail`: 知識の詳細シート
    - ノードクリックで表示

## 2. エラーハンドリング

### 2.1 APIエラー

#### 2.1.1 バリデーションエラー
**ステータスコード**: 400 Bad Request
**レスポンス**:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Title must be at least 1 character(s)"
  }
}
```

#### 2.1.2 リソースが見つからない
**ステータスコード**: 404 Not Found
**レスポンス**:
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Knowledge not found"
  }
}
```

#### 2.1.3 サーバーエラー
**ステータスコード**: 500 Internal Server Error
**レスポンス**:
```json
{
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "An unexpected error occurred"
  }
}
```

### 2.2 フロントエンドエラー

#### 2.2.1 API呼び出しエラー
- エラーメッセージを表示
- ユーザーに再試行を促す

#### 2.2.2 ネットワークエラー
- エラーメッセージを表示
- 接続状態を確認するよう促す

## 3. データモデル

### 3.1 Knowledge（知識）
```typescript
interface Knowledge {
  id: string;                    // 一意のID
  title: string;                 // タイトル（1-200文字）
  content: string;               // コンテンツ（1-10,000文字）
  createdAt: Date;               // 作成日時
  connections: string[];          // 接続されている知識のIDリスト
}
```

### 3.2 SearchResult（検索結果）
```typescript
interface SearchResult {
  knowledge: Knowledge;          // 知識
  relevanceScore: number;        // 関連度スコア
}
```

### 3.3 CreateKnowledgeInput（知識作成入力）
```typescript
interface CreateKnowledgeInput {
  title: string;                 // タイトル
  content: string;               // コンテンツ
}
```

## 4. ユーザーフロー

### 4.1 知識の検索と接続フロー
1. ユーザーが検索ページにアクセス
2. 検索キーワードを入力
3. 検索結果が表示される
4. 関連する知識を複数選択
5. 「Connect」ボタンをクリック
6. 新しい知識が作成され、選択した知識と接続される
7. 検索結果がクリアされる

### 4.2 グラフビューの閲覧フロー
1. ユーザーがグラフページにアクセス
2. 全ての知識がグラフとして表示される
3. ノードをクリックして詳細を確認
4. 必要に応じて設定を変更（日付表示など）
5. リフレッシュボタンで最新データを取得

## 5. パフォーマンス要件

### 5.1 応答時間
- **検索**: 300ms以下
- **知識取得**: 100ms以下
- **知識作成**: 200ms以下
- **知識接続**: 300ms以下

### 5.2 レンダリング
- **グラフ初期表示**: 1秒以下
- **グラフ操作**: 60fps維持

## 6. アクセシビリティ

### 6.1 キーボード操作
- Tabキーでフォーカス移動
- Enterキーで検索実行
- Escapeキーでモーダルを閉じる

### 6.2 スクリーンリーダー
- 適切なaria-labelを設定
- セマンティックHTMLを使用
